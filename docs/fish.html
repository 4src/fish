<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1" />
<meta name="generator" content="pdoc 0.10.0" />
<title>fish API documentation</title>
<meta name="description" content="fish.py: look a little, catch some good stuff
(c) 2023, Tim Menzies, &lt;timm@ieee.org&gt;
BSD-2 â€¦" />
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/sanitize.min.css" integrity="sha256-PK9q560IAAa6WVRRh76LtCaI8pjTJ2z11v0miyNNjrs=" crossorigin>
<link rel="preload stylesheet" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/10up-sanitize.css/11.0.1/typography.min.css" integrity="sha256-7l/o7C8jubJiy74VsKTidCy1yBkRtiUGbVkYBylBqUg=" crossorigin>
<link rel="stylesheet preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/styles/github.min.css" crossorigin>
<style>:root{--highlight-color:#fe9}.flex{display:flex !important}body{line-height:1.5em}#content{padding:20px}#sidebar{padding:30px;overflow:hidden}#sidebar > *:last-child{margin-bottom:2cm}.http-server-breadcrumbs{font-size:130%;margin:0 0 15px 0}#footer{font-size:.75em;padding:5px 30px;border-top:1px solid #ddd;text-align:right}#footer p{margin:0 0 0 1em;display:inline-block}#footer p:last-child{margin-right:30px}h1,h2,h3,h4,h5{font-weight:300}h1{font-size:2.5em;line-height:1.1em}h2{font-size:1.75em;margin:1em 0 .50em 0}h3{font-size:1.4em;margin:25px 0 10px 0}h4{margin:0;font-size:105%}h1:target,h2:target,h3:target,h4:target,h5:target,h6:target{background:var(--highlight-color);padding:.2em 0}a{color:#058;text-decoration:none;transition:color .3s ease-in-out}a:hover{color:#e82}.title code{font-weight:bold}h2[id^="header-"]{margin-top:2em}.ident{color:#900}pre code{background:#f8f8f8;font-size:.8em;line-height:1.4em}code{background:#f2f2f1;padding:1px 4px;overflow-wrap:break-word}h1 code{background:transparent}pre{background:#f8f8f8;border:0;border-top:1px solid #ccc;border-bottom:1px solid #ccc;margin:1em 0;padding:1ex}#http-server-module-list{display:flex;flex-flow:column}#http-server-module-list div{display:flex}#http-server-module-list dt{min-width:10%}#http-server-module-list p{margin-top:0}.toc ul,#index{list-style-type:none;margin:0;padding:0}#index code{background:transparent}#index h3{border-bottom:1px solid #ddd}#index ul{padding:0}#index h4{margin-top:.6em;font-weight:bold}@media (min-width:200ex){#index .two-column{column-count:2}}@media (min-width:300ex){#index .two-column{column-count:3}}dl{margin-bottom:2em}dl dl:last-child{margin-bottom:4em}dd{margin:0 0 1em 3em}#header-classes + dl > dd{margin-bottom:3em}dd dd{margin-left:2em}dd p{margin:10px 0}.name{background:#eee;font-weight:bold;font-size:.85em;padding:5px 10px;display:inline-block;min-width:40%}.name:hover{background:#e0e0e0}dt:target .name{background:var(--highlight-color)}.name > span:first-child{white-space:nowrap}.name.class > span:nth-child(2){margin-left:.4em}.inherited{color:#999;border-left:5px solid #eee;padding-left:1em}.inheritance em{font-style:normal;font-weight:bold}.desc h2{font-weight:400;font-size:1.25em}.desc h3{font-size:1em}.desc dt code{background:inherit}.source summary,.git-link-div{color:#666;text-align:right;font-weight:400;font-size:.8em;text-transform:uppercase}.source summary > *{white-space:nowrap;cursor:pointer}.git-link{color:inherit;margin-left:1em}.source pre{max-height:500px;overflow:auto;margin:0}.source pre code{font-size:12px;overflow:visible}.hlist{list-style:none}.hlist li{display:inline}.hlist li:after{content:',\2002'}.hlist li:last-child:after{content:none}.hlist .hlist{display:inline;padding-left:1em}img{max-width:100%}td{padding:0 .5em}.admonition{padding:.1em .5em;margin-bottom:1em}.admonition-title{font-weight:bold}.admonition.note,.admonition.info,.admonition.important{background:#aef}.admonition.todo,.admonition.versionadded,.admonition.tip,.admonition.hint{background:#dfd}.admonition.warning,.admonition.versionchanged,.admonition.deprecated{background:#fd4}.admonition.error,.admonition.danger,.admonition.caution{background:lightpink}</style>
<style media="screen and (min-width: 700px)">@media screen and (min-width:700px){#sidebar{width:30%;height:100vh;overflow:auto;position:sticky;top:0}#content{width:70%;max-width:100ch;padding:3em 4em;border-left:1px solid #ddd}pre code{font-size:1em}.item .name{font-size:1em}main{display:flex;flex-direction:row-reverse;justify-content:flex-end}.toc ul ul,#index ul{padding-left:1.5em}.toc > ul > li{margin-top:.5em}}</style>
<style media="print">@media print{#sidebar h1{page-break-before:always}.source{display:none}}@media print{*{background:transparent !important;color:#000 !important;box-shadow:none !important;text-shadow:none !important}a[href]:after{content:" (" attr(href) ")";font-size:90%}a[href][title]:after{content:none}abbr[title]:after{content:" (" attr(title) ")"}.ir a:after,a[href^="javascript:"]:after,a[href^="#"]:after{content:""}pre,blockquote{border:1px solid #999;page-break-inside:avoid}thead{display:table-header-group}tr,img{page-break-inside:avoid}img{max-width:100% !important}@page{margin:0.5cm}p,h2,h3{orphans:3;widows:3}h1,h2,h3,h4,h5,h6{page-break-after:avoid}}</style>
<script async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML" integrity="sha256-kZafAc6mZvK3W3v1pHOcUix30OHQN6pU/NO2oFkqZVw=" crossorigin></script>
<script defer src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/10.1.1/highlight.min.js" integrity="sha256-Uv3H6lx7dJmRfRvH8TH6kJD1TSK1aFcwgx+mdg3epi8=" crossorigin></script>
<script>window.addEventListener('DOMContentLoaded', () => hljs.initHighlighting())</script>
&nbsp;
&nbsp;
<a href="https://github.com/4src/fish"> <img
src="https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png" width=35></a>
&nbsp;
<a href="fish.html">fish.py</a>
:: <a href="lib.html">lib.py</a>
:: <a href="tests.html">tests.py</a>
<br clear=all>
<hr>
</head>
<body>
<main>
<article id="content">
<header>
<h1 class="title">Module <code>fish</code></h1>
</header>
<section id="section-intro">
<p>fish.py: look a little, catch some good stuff
<br>
(c) 2023, Tim Menzies, <a href="&#109;&#97;&#105;&#108;&#116;&#111;&#58;&#116;&#105;&#109;&#109;&#64;&#105;&#101;&#101;&#101;&#46;&#111;&#114;&#103;">&#116;&#105;&#109;&#109;&#64;&#105;&#101;&#101;&#101;&#46;&#111;&#114;&#103;</a>
BSD-2
</p>
<pre><code>          O  o    
     _\_   o    
  \/   o\ .    
  //\___=    
     ''
</code></pre>
<p>USAGE: </p>
<pre><code>  ./gofish.py [OPTIONS] [-g ACTIONs]
</code></pre>
<p>OPTIONS:
</p>
<pre><code>  -b  --bins    number of bins                         = 16    
  -B  --bootstrap number of bootstap samples           = 512  
  -c  --cohen   'not different' if under the.cohen*sd  = .2    
  -C  --Cliffs  Cliff's Delta limit                    = .147  
  -f  --file    data csv file                          = ../data/auto93.csv    
  -g  --go      start up action                        = nothing    
  -h  --help    show help                              = False    
  -m  --min     on N items, recurse down to N**min     = .5    
  -n  -n        explore all subsets of top ''n bins    = 7
  -r  --rest    expand to len(list)*rest               = 4    
  -s  --seed    random number seed                     = 1234567891    
  -S  --Some    max items kept in SOME                 = 512  
  -w --want     goal: plan,watch,xplore,doubt          = plan
</code></pre>
<p>NOTES:</p>
<p>This code reads CSV files with a header row listing column names,
numeric columns, symbolic columns and goals. For example, in this
data set, we want to learn what values of <code>name,Age,Shoesize</code>
are associated with most
<code>Salary</code> and least <code>Weight</code>.</p>
<pre><code>     name,  Age,  Shoesize, Salary+,  Weight-
      tim,   31,        11,  200000,      30
    susan,   41,         8,  300000,      50
     jane,   20,        20,  100000,      40
      ...   ...        ...      ...      ...
</code></pre>
<p>Nums start with upper case (and everything else is a Sym). Goals
end in "<code>-</code>" or "<code>+</code>" for things to minimize or maximize. Anything ending
with <code>X</code> is ignored.</p>
<p>Rows are then ranked on the goals, using a multi-objective domination
predicate (from Zitzler's 2004 work).
Attribute ranges are
binned, favoring those most different in the best and worst ranked
rows.
All <span><span class="MathJax_Preview">2^n</span><script type="math/tex">2^n</script></span> subsets of the best <em>n</em> bins are then explored to find
the smallest subset that most selects for top ranked rows.</p>
<p>This code keeps code to 100 chars wide. It also uses <code>i</code> in place of <code>self</code>
and classes get initialized from a <code>slots</code> (why? causes its shorter). Also,
this code does not conform to PEP8 standards (why? causes that would be longer).</p>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">#&lt;!-- vim: set ts=2 sw=2 et: --&gt;
&#34;&#34;&#34;
fish.py: look a little, catch some good stuff    
(c) 2023, Tim Menzies, &lt;timm@ieee.org&gt;  BSD-2    

              O  o    
         _\_   o    
      \\/   o\ .    
      //\___=    
         &#39;&#39;    

USAGE: 

      ./gofish.py [OPTIONS] [-g ACTIONs]    

OPTIONS:    

      -b  --bins    number of bins                         = 16    
      -B  --bootstrap number of bootstap samples           = 512  
      -c  --cohen   &#39;not different&#39; if under the.cohen*sd  = .2    
      -C  --Cliffs  Cliff&#39;s Delta limit                    = .147  
      -f  --file    data csv file                          = ../data/auto93.csv    
      -g  --go      start up action                        = nothing    
      -h  --help    show help                              = False    
      -m  --min     on N items, recurse down to N**min     = .5    
      -n  -n        explore all subsets of top &#39;&#39;n bins    = 7
      -r  --rest    expand to len(list)*rest               = 4    
      -s  --seed    random number seed                     = 1234567891    
      -S  --Some    max items kept in SOME                 = 512  
      -w --want     goal: plan,watch,xplore,doubt          = plan   

NOTES:

This code reads CSV files with a header row listing column names,
numeric columns, symbolic columns and goals. For example, in this
data set, we want to learn what values of `name,Age,Shoesize`
are associated with most  `Salary` and least `Weight`.

         name,  Age,  Shoesize, Salary+,  Weight-
          tim,   31,        11,  200000,      30
        susan,   41,         8,  300000,      50
         jane,   20,        20,  100000,      40
          ...   ...        ...      ...      ...

Nums start with upper case (and everything else is a Sym). Goals
end in &#34;`-`&#34; or &#34;`+`&#34; for things to minimize or maximize. Anything ending
with `X` is ignored.

Rows are then ranked on the goals, using a multi-objective domination
predicate (from Zitzler&#39;s 2004 work).  Attribute ranges are
binned, favoring those most different in the best and worst ranked
rows.  All \(2^n\) subsets of the best _n_ bins are then explored to find
the smallest subset that most selects for top ranked rows.

This code keeps code to 100 chars wide. It also uses `i` in place of `self`
and classes get initialized from a `slots` (why? causes its shorter). Also,
this code does not conform to PEP8 standards (why? causes that would be longer).
&#34;&#34;&#34;
from functools import cmp_to_key as cmp2key
from typing    import Dict, Any, List
from termcolor import colored
from copy      import deepcopy
import random, math, ast, sys, re, os

class obj(object):
  id=0
  def __init__(i, **d): i.__dict__.update(**i.slots(**d)); i.id = obj.id = obj.id+1
  def slots(i,**d)    : return d
  def __repr__(i)     : return i.__class__.__name__+showd(i.__dict__)
  def __hash__(i)     : return i.id

def coerce(x):
  try   : return ast.literal_eval(x)
  except: return x

the= obj(**{m[1]:coerce(m[2]) for m in re.finditer(
            r&#34;\n\s*-\w+\s*--(\w+)[^=]*=\s*(\S+)&#34;, __doc__)})
#-----------------------------------------------------------------------------

# Summarizes  column one as `lo` to `hi` and column two by the symbols
#  in that column. Keeps the rows seen. 
class BIN(obj):

  # BIN contents.
  def slots(i, at=0, txt=&#34;&#34;, lo=None, hi=None):
    lo = lo or inf
    hi = hi or lo
    return dict(at=at,txt=txt,lo=lo,hi= hi,n=0,_rows=[],ys={},score=0)

  def add(i,x,y,row):
    &#34;Updates `i.lo` to `i.hi` from `i.x` and  `ys` from `y`.&#34;
    if x==&#34;?&#34;: return x
    i.n += 1
    i.lo = min(i.lo,x)
    i.hi = max(i.hi,x)
    i._rows += [row]
    i.ys[y] = 1 + i.ys.get(y,0)

  def merge(i,j):
    &#34;&#34;&#34;Merge two adjacent bins.&#34;&#34;&#34;
    out = BIN(at=i.at, txt=i.txt, lo=i.lo, hi=j.hi)
    out._rows = i._rows + j._rows
    out.n = i.n + j.n
    for d in [i.ys, j.ys]:
      for key in d:
        out.ys[key] = d[key] + out.ys.get(key,0)
    return out

  def merged(i,j,num):
    out   = i.merge(j)
    small = num.n / the.bins
    eps   = num.sd*the.cohen
    if i.n &lt;= small or i.hi - i.lo &lt; eps : return out
    if j.n &lt;= small or j.hi - j.lo &lt; eps : return out
    e1, e2, e3 = entropy(i.ys), entropy(j.ys), entropy(out.ys)
    if e3 &lt;= (i.n*e1 + j.n*e2)/out.n : return out

#-----------------------------------------------------------------------------
def COLS(names):
  &#34;Factory for turning column names into COLs.&#34;
  cols,x,y = [COL(at=i,txt=s) for i,s in enumerate(names)], [], []
  for col in cols:
    if col.txt[-1] != &#34;X&#34;:
      (y if col.txt[-1] in &#34;+-&#34; else x).append(col)
  return names,cols,x,y

def COL(at=0,txt=&#34; &#34;):
  &#34;Factory for turning one column name into a NUM or SYM.&#34;
  w = -1 if txt[-1] == &#34;-&#34; else 1
  return NUM(at=at,txt=txt,w=w) if txt[0].isupper() else SYM(at=at,txt=txt)

class col(obj):
  &#34;Super class of NUM and SYM.&#34;
  def slots(i,at=0,txt=&#34; &#34;):
    &#34;Cols have at least a name and a position in the row.&#34;
    return dict(at=at, txt=txt, bins={}, n=0)

  def adds(i,lst): 
    &#34;Add many things to a COL.&#34;
    [i.add(x) for x in lst]; return i

  def add(i,x,inc=1):
    &#34;Add thing `x` to a COL (ignoring empty cells).&#34;
    if x==&#34;?&#34;: return x
    i.n += inc
    i.add1(x,inc)

  def bin(i,x,y,row):
    k = i.descretize(x)
    if not k in i.bins: i.bins[k] = BIN(at=i.at, txt=i.txt, lo=x)
    i.bins[k].add(x,y,row)

#-------------------------------------------------------------------------------
class SYM(col):
  def slots(i,**d): return super().slots(**d) | dict(has={},mode=None,most=0)

  def mid(i): return i.mode
  def div(i): return entropy(i.has)
  def stats(i, div=False, **_) : return i.div() if div else i.mid()

  def add1(i,x,inc=1):
    i.has = i.has or {}
    tmp = i.has[x] = inc + i.has.get(x,0)
    if tmp &gt; i.most: i.most,i.mode = tmp,x

  def descretize(i,x): return x
  def merges(i,bins): return bins

#-------------------------------------------------------------------------------
class NUM(col):
  def slots(i,at=0,txt=&#34; &#34;,w=1) :
    return super().slots(at=at,txt=txt) | dict(w=1,mu=0,m2=0,sd=0,lo=inf,hi=ninf)

  def mid(i): return i.mu
  def div(i): return i.sd
  def norm(i,x): return x if x==&#34;?&#34; else (x - i.lo) / (i.hi - i.lo + tiny)
  def stats(i,div=False,rnd=2): return round(i.div() if div else i.mid(), rnd)

  def descretize(i,x):
    lo,hi = i.mu - 2*i.sd, i.mu + 2*i.sd
    return int(the.bins*(x - lo)/(hi-lo + tiny))

  def add1(i,x,n):
    i.lo  = min(i.lo, x)
    i.hi  = max(i.hi, x)
    d     = x - i.mu
    i.mu += d/i.n
    i.m2 += d*(x - i.mu)
    i.sd  = 0 if i.n&lt;2 else (i.m2/(i.n - 1))**.5

  def merges(i,bins):
    bins = recrusivelyMergeNeighbors(bins,i)
    for j in range(len(bins)-1): bins[j].hi = bins[j+1].lo
    bins[ 0].lo = ninf
    bins[-1].hi =  inf
    return bins

  def delta(i,j):
    return abs(i.mu - j.mu) / ((i.sd^2/i.n + j.sd^2/j.n)**.5 + tiny)

class SOME(col):
  def slots(i): return dict(ok=True, w=1, _has=[])

  def add1(i,x,_):
    a = i._has
    if   len(a) &lt; the.Some  : i.ok=False; a += [x]
    elif r() &lt; the.Some/i.n : i.ok=False; a[ int(len(a)*r()) ] = x

  def has(i):
    if not i.ok: i._has=sorted(i._has)
    i.sorted=True
    return i._has

  def same(i,j):
    return i.cliffsDelta(j) and i.bootstrap(j)

  def cliffsDelta(i,j):
    n,x,y = 0,i._has, j._has
    if len(x) &gt; 10*len(y): x = random.choices(x,10*len(y))
    if len(y) &gt; 10*len(x): y = random.choices(y,10*len(x))
    for x1 in x:
      for y1 in y:
        n = n + 1
        if x1 &gt; y1: gt = gt + 1 
        if x1 &lt; y1: lt = lt + 1 
    return abs(lt - gt)/n &gt; the.cliffs 

  def bootstrap(i,j,conf=.05):
    y0,z0   = i._has, j._has
    x, y, z = NUM(), NUM(), NUM()
    for y1 in y0: x.add(y1); y.add(y1) 
    for z1 in z0: x.add(z1); z.add(z1) 
    yhat    = [y1 - y.mu + x.mu for y1 in y0]
    zhat    = [z1 - z.mu + x.mu for z1 in z0]
    overall = y.delta(z)
    n       = 0
    for _ in range(the.bootstrap):
      ynum = NUM().adds(sample(yhat))
      znum = NUM().adds(sample(zhat))
      if ynum.delta(znum)  &gt; overall: n += 1
    return n / the.bootstrap &gt;= conf

#-------------------------------------------------------------------------------
class ROW(obj):
  def slots(i,cells=[]): return dict(cells=cells)
  def better(i,j,data):
    s1, s2, cols, n = 0, 0, data.y, len(data.y)
    for col in cols:
      a,b  = col.norm(i.cells[col.at]), col.norm(j.cells[col.at])
      s1  -= math.exp(col.w * (a - b) / n)
      s2  -= math.exp(col.w * (b - a) / n)
    return s1 / n &lt; s2 / n

#-------------------------------------------------------------------------------
class DATA(obj):
  def slots(i):  return dict(x=[], y=[], cols=[], names=[], rows=[])
  def clone(i,rows=[]):
    d = DATA()
    d.names, d.cols, d.x, d.y = COLS(i.names)
    [d.add(row) for row in rows]
    return d

  def read(i,file):
    with open(file) as fp:
      for line in fp:
        line = re.sub(r&#39;([\n\t\r&#34;\&#39; ]|#.*)&#39;, &#39;&#39;, line)
        if line:
          i.add(ROW(cells = [coerce(s.strip()) for s in line.split(&#34;,&#34;)]))
    return i

  def add(i,row):
    if i.x:
      [col.add(row.cells[col.at]) for cols in [i.x, i.y] for col in cols]
      i.rows += [row]
    else:
      i.names, i.cols, i.x, i.y = COLS(row.cells)
    return i

  def stats(i, cols=None, div=False, rnd=2):
    return obj(N=len(i.rows), **{col.txt: col.stats(div=div, rnd=rnd)
                                 for col in (cols or i.y)})

  def betters(i):
    rows = sorted(i.rows, key=cmp2key(lambda r1,r2: r1.better(r2,i)))
    cut  = len(rows) - int(len(rows))**the.min
    best,rest = [],[]
    for j,row in enumerate(rows):
      row.y = j &gt; cut
      (best if j &gt; cut else rest).append(row)
    rest = random.sample(rest, len(best)*the.rest)
    return i.clone(best), i.clone(rest)

#-------------------------------------------------------------------------------
def contrasts(data1,data2):
  data12 = data1.clone(data1.rows + data2.rows)
  for col in data12.x:
    for klass,rows in dict(best=data1.rows, rest=data2.rows).items():
      for row in rows:
        col.bin(row.cells[col.at], klass, row)
    for bin in col.merges(sorted(col.bins.values(),key=lambda b:b.lo)):
      bin.score = want(bin.ys.get(&#34;best&#34;,0), bin.ys.get(&#34;rest&#34;,0),
                       len(data1.rows), len(data2.rows))
      yield bin

def want(b,r,B,R):
  b, r = b/(B+tiny), r/(R+tiny)
  match the.want:
    case &#34;plan&#34;:   return b**2/(b+r)
    case &#34;watch&#34;:  return r**2/(b+r)
    case &#34;xplore&#34;: return 1/(b+r)
    case &#34;doubt&#34;:  return (b+r)/abs(b - r)

def rules(data1,data2):
  a = sorted((bin for bin in contrasts(data1,data2)),
              reversed=True, key=lambda x:x.score)
  print([x.score for x in a])

#-------------------------------------------------------------------------------
# # Misc Stuff

inf  = 1E60
tiny = 1/inf
ninf = -inf

def sample(a):
  return random.choices(a,k=len(a))

def recrusivelyMergeNeighbors(a, *l):
  b,j = [],0
  while j &lt; len(a):
    now = a[j]
    if j &lt; len(a) - 1:
      if new := now.merged(a[j+1], *l):
        now, j = new, j+1
    b += [now]
    j += 1
  return a if len(a) == len(b) else recrusivelyMergeNeighbors(b, *l)

def entropy(d):
  N = sum((d[k] for k in d))
  return -sum((n/N*math.log(n/N,2) for n in d.values() if n &gt; 0))

def showd(d):
   return &#34;{&#34;+(&#34; &#34;.join([f&#34;:{k} {show(v)}&#34; for k,v in sorted(d.items()) if k[0]!=&#34;_&#34;]))+&#34;}&#34;

def show(x):
  if callable(x)         : return x.__name__+&#39;()&#39;
  if isinstance(x,float) : return f&#34;{x:.2f}&#34;
  return x

def prin(*l) :  print(*l,end=&#34;&#34;)
def round2(x):  return round(x, ndigits=2)


def flip(file):
  with open(file) as fp:
    s= fp.read()
    f= lambda m:&#34;\n\n# &#34;+ re.sub(&#34;\n&#34;,&#34;\n# &#34;,m[4].strip(&#34;[\s]+&#34;))+&#34;\n&#34;+m[2]+m[1]+&#34;\n&#34;
    return re.sub(
              r&#39;\n(([ \t]*)(def|class)[^\n]+)\n[ \t]*&#34;&#34;&#34;([^&#34;]+)[\n]?&#34;&#34;&#34;[\s]*\n&#39;,f,s)</code></pre>
</details>
</section>
<section>
</section>
<section>
</section>
<section>
<h2 class="section-title" id="header-functions">Functions</h2>
<dl>
<dt id="fish.coerce"><code class="name flex">
<span>def <span class="ident">coerce</span></span>(<span>x)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def coerce(x):
  try   : return ast.literal_eval(x)
  except: return x</code></pre>
</details>
</dd>
<dt id="fish.COLS"><code class="name flex">
<span>def <span class="ident">COLS</span></span>(<span>names)</span>
</code></dt>
<dd>
<div class="desc"><p>Factory for turning column names into COLs.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def COLS(names):
  &#34;Factory for turning column names into COLs.&#34;
  cols,x,y = [COL(at=i,txt=s) for i,s in enumerate(names)], [], []
  for col in cols:
    if col.txt[-1] != &#34;X&#34;:
      (y if col.txt[-1] in &#34;+-&#34; else x).append(col)
  return names,cols,x,y</code></pre>
</details>
</dd>
<dt id="fish.COL"><code class="name flex">
<span>def <span class="ident">COL</span></span>(<span>at=0, txt=' ')</span>
</code></dt>
<dd>
<div class="desc"><p>Factory for turning one column name into a NUM or SYM.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def COL(at=0,txt=&#34; &#34;):
  &#34;Factory for turning one column name into a NUM or SYM.&#34;
  w = -1 if txt[-1] == &#34;-&#34; else 1
  return NUM(at=at,txt=txt,w=w) if txt[0].isupper() else SYM(at=at,txt=txt)</code></pre>
</details>
</dd>
<dt id="fish.contrasts"><code class="name flex">
<span>def <span class="ident">contrasts</span></span>(<span>data1, data2)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def contrasts(data1,data2):
  data12 = data1.clone(data1.rows + data2.rows)
  for col in data12.x:
    for klass,rows in dict(best=data1.rows, rest=data2.rows).items():
      for row in rows:
        col.bin(row.cells[col.at], klass, row)
    for bin in col.merges(sorted(col.bins.values(),key=lambda b:b.lo)):
      bin.score = want(bin.ys.get(&#34;best&#34;,0), bin.ys.get(&#34;rest&#34;,0),
                       len(data1.rows), len(data2.rows))
      yield bin</code></pre>
</details>
</dd>
<dt id="fish.want"><code class="name flex">
<span>def <span class="ident">want</span></span>(<span>b, r, B, R)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def want(b,r,B,R):
  b, r = b/(B+tiny), r/(R+tiny)
  match the.want:
    case &#34;plan&#34;:   return b**2/(b+r)
    case &#34;watch&#34;:  return r**2/(b+r)
    case &#34;xplore&#34;: return 1/(b+r)
    case &#34;doubt&#34;:  return (b+r)/abs(b - r)</code></pre>
</details>
</dd>
<dt id="fish.rules"><code class="name flex">
<span>def <span class="ident">rules</span></span>(<span>data1, data2)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def rules(data1,data2):
  a = sorted((bin for bin in contrasts(data1,data2)),
              reversed=True, key=lambda x:x.score)
  print([x.score for x in a])</code></pre>
</details>
</dd>
<dt id="fish.sample"><code class="name flex">
<span>def <span class="ident">sample</span></span>(<span>a)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def sample(a):
  return random.choices(a,k=len(a))</code></pre>
</details>
</dd>
<dt id="fish.recrusivelyMergeNeighbors"><code class="name flex">
<span>def <span class="ident">recrusivelyMergeNeighbors</span></span>(<span>a, *l)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def recrusivelyMergeNeighbors(a, *l):
  b,j = [],0
  while j &lt; len(a):
    now = a[j]
    if j &lt; len(a) - 1:
      if new := now.merged(a[j+1], *l):
        now, j = new, j+1
    b += [now]
    j += 1
  return a if len(a) == len(b) else recrusivelyMergeNeighbors(b, *l)</code></pre>
</details>
</dd>
<dt id="fish.entropy"><code class="name flex">
<span>def <span class="ident">entropy</span></span>(<span>d)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def entropy(d):
  N = sum((d[k] for k in d))
  return -sum((n/N*math.log(n/N,2) for n in d.values() if n &gt; 0))</code></pre>
</details>
</dd>
<dt id="fish.showd"><code class="name flex">
<span>def <span class="ident">showd</span></span>(<span>d)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def showd(d):
   return &#34;{&#34;+(&#34; &#34;.join([f&#34;:{k} {show(v)}&#34; for k,v in sorted(d.items()) if k[0]!=&#34;_&#34;]))+&#34;}&#34;</code></pre>
</details>
</dd>
<dt id="fish.show"><code class="name flex">
<span>def <span class="ident">show</span></span>(<span>x)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def show(x):
  if callable(x)         : return x.__name__+&#39;()&#39;
  if isinstance(x,float) : return f&#34;{x:.2f}&#34;
  return x</code></pre>
</details>
</dd>
<dt id="fish.prin"><code class="name flex">
<span>def <span class="ident">prin</span></span>(<span>*l)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def prin(*l) :  print(*l,end=&#34;&#34;)</code></pre>
</details>
</dd>
<dt id="fish.round2"><code class="name flex">
<span>def <span class="ident">round2</span></span>(<span>x)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def round2(x):  return round(x, ndigits=2)</code></pre>
</details>
</dd>
<dt id="fish.flip"><code class="name flex">
<span>def <span class="ident">flip</span></span>(<span>file)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def flip(file):
  with open(file) as fp:
    s= fp.read()
    f= lambda m:&#34;\n\n# &#34;+ re.sub(&#34;\n&#34;,&#34;\n# &#34;,m[4].strip(&#34;[\s]+&#34;))+&#34;\n&#34;+m[2]+m[1]+&#34;\n&#34;
    return re.sub(
              r&#39;\n(([ \t]*)(def|class)[^\n]+)\n[ \t]*&#34;&#34;&#34;([^&#34;]+)[\n]?&#34;&#34;&#34;[\s]*\n&#39;,f,s)</code></pre>
</details>
</dd>
</dl>
</section>
<section>
<h2 class="section-title" id="header-classes">Classes</h2>
<dl>
<dt id="fish.obj"><code class="flex name class">
<span>class <span class="ident">obj</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class obj(object):
  id=0
  def __init__(i, **d): i.__dict__.update(**i.slots(**d)); i.id = obj.id = obj.id+1
  def slots(i,**d)    : return d
  def __repr__(i)     : return i.__class__.__name__+showd(i.__dict__)
  def __hash__(i)     : return i.id</code></pre>
</details>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="fish.BIN" href="#fish.BIN">BIN</a></li>
<li><a title="fish.DATA" href="#fish.DATA">DATA</a></li>
<li><a title="fish.ROW" href="#fish.ROW">ROW</a></li>
<li><a title="fish.col" href="#fish.col">col</a></li>
</ul>
<h3>Class variables</h3>
<dl>
<dt id="fish.obj.id"><code class="name">var <span class="ident">id</span></code></dt>
<dd>
<div class="desc"></div>
</dd>
</dl>
<h3>Methods</h3>
<dl>
<dt id="fish.obj.slots"><code class="name flex">
<span>def <span class="ident">slots</span></span>(<span>i, **d)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def slots(i,**d)    : return d</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="fish.BIN"><code class="flex name class">
<span>class <span class="ident">BIN</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class BIN(obj):

  # BIN contents.
  def slots(i, at=0, txt=&#34;&#34;, lo=None, hi=None):
    lo = lo or inf
    hi = hi or lo
    return dict(at=at,txt=txt,lo=lo,hi= hi,n=0,_rows=[],ys={},score=0)

  def add(i,x,y,row):
    &#34;Updates `i.lo` to `i.hi` from `i.x` and  `ys` from `y`.&#34;
    if x==&#34;?&#34;: return x
    i.n += 1
    i.lo = min(i.lo,x)
    i.hi = max(i.hi,x)
    i._rows += [row]
    i.ys[y] = 1 + i.ys.get(y,0)

  def merge(i,j):
    &#34;&#34;&#34;Merge two adjacent bins.&#34;&#34;&#34;
    out = BIN(at=i.at, txt=i.txt, lo=i.lo, hi=j.hi)
    out._rows = i._rows + j._rows
    out.n = i.n + j.n
    for d in [i.ys, j.ys]:
      for key in d:
        out.ys[key] = d[key] + out.ys.get(key,0)
    return out

  def merged(i,j,num):
    out   = i.merge(j)
    small = num.n / the.bins
    eps   = num.sd*the.cohen
    if i.n &lt;= small or i.hi - i.lo &lt; eps : return out
    if j.n &lt;= small or j.hi - j.lo &lt; eps : return out
    e1, e2, e3 = entropy(i.ys), entropy(j.ys), entropy(out.ys)
    if e3 &lt;= (i.n*e1 + j.n*e2)/out.n : return out</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="fish.obj" href="#fish.obj">obj</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="fish.BIN.slots"><code class="name flex">
<span>def <span class="ident">slots</span></span>(<span>i, at=0, txt='', lo=None, hi=None)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def slots(i, at=0, txt=&#34;&#34;, lo=None, hi=None):
  lo = lo or inf
  hi = hi or lo
  return dict(at=at,txt=txt,lo=lo,hi= hi,n=0,_rows=[],ys={},score=0)</code></pre>
</details>
</dd>
<dt id="fish.BIN.add"><code class="name flex">
<span>def <span class="ident">add</span></span>(<span>i, x, y, row)</span>
</code></dt>
<dd>
<div class="desc"><p>Updates <code>i.lo</code> to <code>i.hi</code> from <code>i.x</code> and
<code>ys</code> from <code>y</code>.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add(i,x,y,row):
  &#34;Updates `i.lo` to `i.hi` from `i.x` and  `ys` from `y`.&#34;
  if x==&#34;?&#34;: return x
  i.n += 1
  i.lo = min(i.lo,x)
  i.hi = max(i.hi,x)
  i._rows += [row]
  i.ys[y] = 1 + i.ys.get(y,0)</code></pre>
</details>
</dd>
<dt id="fish.BIN.merge"><code class="name flex">
<span>def <span class="ident">merge</span></span>(<span>i, j)</span>
</code></dt>
<dd>
<div class="desc"><p>Merge two adjacent bins.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def merge(i,j):
  &#34;&#34;&#34;Merge two adjacent bins.&#34;&#34;&#34;
  out = BIN(at=i.at, txt=i.txt, lo=i.lo, hi=j.hi)
  out._rows = i._rows + j._rows
  out.n = i.n + j.n
  for d in [i.ys, j.ys]:
    for key in d:
      out.ys[key] = d[key] + out.ys.get(key,0)
  return out</code></pre>
</details>
</dd>
<dt id="fish.BIN.merged"><code class="name flex">
<span>def <span class="ident">merged</span></span>(<span>i, j, num)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def merged(i,j,num):
  out   = i.merge(j)
  small = num.n / the.bins
  eps   = num.sd*the.cohen
  if i.n &lt;= small or i.hi - i.lo &lt; eps : return out
  if j.n &lt;= small or j.hi - j.lo &lt; eps : return out
  e1, e2, e3 = entropy(i.ys), entropy(j.ys), entropy(out.ys)
  if e3 &lt;= (i.n*e1 + j.n*e2)/out.n : return out</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="fish.col"><code class="flex name class">
<span>class <span class="ident">col</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"><p>Super class of NUM and SYM.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class col(obj):
  &#34;Super class of NUM and SYM.&#34;
  def slots(i,at=0,txt=&#34; &#34;):
    &#34;Cols have at least a name and a position in the row.&#34;
    return dict(at=at, txt=txt, bins={}, n=0)

  def adds(i,lst): 
    &#34;Add many things to a COL.&#34;
    [i.add(x) for x in lst]; return i

  def add(i,x,inc=1):
    &#34;Add thing `x` to a COL (ignoring empty cells).&#34;
    if x==&#34;?&#34;: return x
    i.n += inc
    i.add1(x,inc)

  def bin(i,x,y,row):
    k = i.descretize(x)
    if not k in i.bins: i.bins[k] = BIN(at=i.at, txt=i.txt, lo=x)
    i.bins[k].add(x,y,row)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="fish.obj" href="#fish.obj">obj</a></li>
</ul>
<h3>Subclasses</h3>
<ul class="hlist">
<li><a title="fish.NUM" href="#fish.NUM">NUM</a></li>
<li><a title="fish.SOME" href="#fish.SOME">SOME</a></li>
<li><a title="fish.SYM" href="#fish.SYM">SYM</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="fish.col.slots"><code class="name flex">
<span>def <span class="ident">slots</span></span>(<span>i, at=0, txt=' ')</span>
</code></dt>
<dd>
<div class="desc"><p>Cols have at least a name and a position in the row.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def slots(i,at=0,txt=&#34; &#34;):
  &#34;Cols have at least a name and a position in the row.&#34;
  return dict(at=at, txt=txt, bins={}, n=0)</code></pre>
</details>
</dd>
<dt id="fish.col.adds"><code class="name flex">
<span>def <span class="ident">adds</span></span>(<span>i, lst)</span>
</code></dt>
<dd>
<div class="desc"><p>Add many things to a COL.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def adds(i,lst): 
  &#34;Add many things to a COL.&#34;
  [i.add(x) for x in lst]; return i</code></pre>
</details>
</dd>
<dt id="fish.col.add"><code class="name flex">
<span>def <span class="ident">add</span></span>(<span>i, x, inc=1)</span>
</code></dt>
<dd>
<div class="desc"><p>Add thing <code>x</code> to a COL (ignoring empty cells).</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add(i,x,inc=1):
  &#34;Add thing `x` to a COL (ignoring empty cells).&#34;
  if x==&#34;?&#34;: return x
  i.n += inc
  i.add1(x,inc)</code></pre>
</details>
</dd>
<dt id="fish.col.bin"><code class="name flex">
<span>def <span class="ident">bin</span></span>(<span>i, x, y, row)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def bin(i,x,y,row):
  k = i.descretize(x)
  if not k in i.bins: i.bins[k] = BIN(at=i.at, txt=i.txt, lo=x)
  i.bins[k].add(x,y,row)</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="fish.SYM"><code class="flex name class">
<span>class <span class="ident">SYM</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"><p>Super class of NUM and SYM.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class SYM(col):
  def slots(i,**d): return super().slots(**d) | dict(has={},mode=None,most=0)

  def mid(i): return i.mode
  def div(i): return entropy(i.has)
  def stats(i, div=False, **_) : return i.div() if div else i.mid()

  def add1(i,x,inc=1):
    i.has = i.has or {}
    tmp = i.has[x] = inc + i.has.get(x,0)
    if tmp &gt; i.most: i.most,i.mode = tmp,x

  def descretize(i,x): return x
  def merges(i,bins): return bins</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="fish.col" href="#fish.col">col</a></li>
<li><a title="fish.obj" href="#fish.obj">obj</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="fish.SYM.mid"><code class="name flex">
<span>def <span class="ident">mid</span></span>(<span>i)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mid(i): return i.mode</code></pre>
</details>
</dd>
<dt id="fish.SYM.div"><code class="name flex">
<span>def <span class="ident">div</span></span>(<span>i)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def div(i): return entropy(i.has)</code></pre>
</details>
</dd>
<dt id="fish.SYM.stats"><code class="name flex">
<span>def <span class="ident">stats</span></span>(<span>i, div=False, **_)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def stats(i, div=False, **_) : return i.div() if div else i.mid()</code></pre>
</details>
</dd>
<dt id="fish.SYM.add1"><code class="name flex">
<span>def <span class="ident">add1</span></span>(<span>i, x, inc=1)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add1(i,x,inc=1):
  i.has = i.has or {}
  tmp = i.has[x] = inc + i.has.get(x,0)
  if tmp &gt; i.most: i.most,i.mode = tmp,x</code></pre>
</details>
</dd>
<dt id="fish.SYM.descretize"><code class="name flex">
<span>def <span class="ident">descretize</span></span>(<span>i, x)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def descretize(i,x): return x</code></pre>
</details>
</dd>
<dt id="fish.SYM.merges"><code class="name flex">
<span>def <span class="ident">merges</span></span>(<span>i, bins)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def merges(i,bins): return bins</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="fish.col" href="#fish.col">col</a></b></code>:
<ul class="hlist">
<li><code><a title="fish.col.add" href="#fish.col.add">add</a></code></li>
<li><code><a title="fish.col.adds" href="#fish.col.adds">adds</a></code></li>
<li><code><a title="fish.col.slots" href="#fish.col.slots">slots</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="fish.NUM"><code class="flex name class">
<span>class <span class="ident">NUM</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"><p>Super class of NUM and SYM.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class NUM(col):
  def slots(i,at=0,txt=&#34; &#34;,w=1) :
    return super().slots(at=at,txt=txt) | dict(w=1,mu=0,m2=0,sd=0,lo=inf,hi=ninf)

  def mid(i): return i.mu
  def div(i): return i.sd
  def norm(i,x): return x if x==&#34;?&#34; else (x - i.lo) / (i.hi - i.lo + tiny)
  def stats(i,div=False,rnd=2): return round(i.div() if div else i.mid(), rnd)

  def descretize(i,x):
    lo,hi = i.mu - 2*i.sd, i.mu + 2*i.sd
    return int(the.bins*(x - lo)/(hi-lo + tiny))

  def add1(i,x,n):
    i.lo  = min(i.lo, x)
    i.hi  = max(i.hi, x)
    d     = x - i.mu
    i.mu += d/i.n
    i.m2 += d*(x - i.mu)
    i.sd  = 0 if i.n&lt;2 else (i.m2/(i.n - 1))**.5

  def merges(i,bins):
    bins = recrusivelyMergeNeighbors(bins,i)
    for j in range(len(bins)-1): bins[j].hi = bins[j+1].lo
    bins[ 0].lo = ninf
    bins[-1].hi =  inf
    return bins

  def delta(i,j):
    return abs(i.mu - j.mu) / ((i.sd^2/i.n + j.sd^2/j.n)**.5 + tiny)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="fish.col" href="#fish.col">col</a></li>
<li><a title="fish.obj" href="#fish.obj">obj</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="fish.NUM.mid"><code class="name flex">
<span>def <span class="ident">mid</span></span>(<span>i)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def mid(i): return i.mu</code></pre>
</details>
</dd>
<dt id="fish.NUM.div"><code class="name flex">
<span>def <span class="ident">div</span></span>(<span>i)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def div(i): return i.sd</code></pre>
</details>
</dd>
<dt id="fish.NUM.norm"><code class="name flex">
<span>def <span class="ident">norm</span></span>(<span>i, x)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def norm(i,x): return x if x==&#34;?&#34; else (x - i.lo) / (i.hi - i.lo + tiny)</code></pre>
</details>
</dd>
<dt id="fish.NUM.stats"><code class="name flex">
<span>def <span class="ident">stats</span></span>(<span>i, div=False, rnd=2)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def stats(i,div=False,rnd=2): return round(i.div() if div else i.mid(), rnd)</code></pre>
</details>
</dd>
<dt id="fish.NUM.descretize"><code class="name flex">
<span>def <span class="ident">descretize</span></span>(<span>i, x)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def descretize(i,x):
  lo,hi = i.mu - 2*i.sd, i.mu + 2*i.sd
  return int(the.bins*(x - lo)/(hi-lo + tiny))</code></pre>
</details>
</dd>
<dt id="fish.NUM.add1"><code class="name flex">
<span>def <span class="ident">add1</span></span>(<span>i, x, n)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add1(i,x,n):
  i.lo  = min(i.lo, x)
  i.hi  = max(i.hi, x)
  d     = x - i.mu
  i.mu += d/i.n
  i.m2 += d*(x - i.mu)
  i.sd  = 0 if i.n&lt;2 else (i.m2/(i.n - 1))**.5</code></pre>
</details>
</dd>
<dt id="fish.NUM.merges"><code class="name flex">
<span>def <span class="ident">merges</span></span>(<span>i, bins)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def merges(i,bins):
  bins = recrusivelyMergeNeighbors(bins,i)
  for j in range(len(bins)-1): bins[j].hi = bins[j+1].lo
  bins[ 0].lo = ninf
  bins[-1].hi =  inf
  return bins</code></pre>
</details>
</dd>
<dt id="fish.NUM.delta"><code class="name flex">
<span>def <span class="ident">delta</span></span>(<span>i, j)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def delta(i,j):
  return abs(i.mu - j.mu) / ((i.sd^2/i.n + j.sd^2/j.n)**.5 + tiny)</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="fish.col" href="#fish.col">col</a></b></code>:
<ul class="hlist">
<li><code><a title="fish.col.add" href="#fish.col.add">add</a></code></li>
<li><code><a title="fish.col.adds" href="#fish.col.adds">adds</a></code></li>
<li><code><a title="fish.col.slots" href="#fish.col.slots">slots</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="fish.SOME"><code class="flex name class">
<span>class <span class="ident">SOME</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"><p>Super class of NUM and SYM.</p></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class SOME(col):
  def slots(i): return dict(ok=True, w=1, _has=[])

  def add1(i,x,_):
    a = i._has
    if   len(a) &lt; the.Some  : i.ok=False; a += [x]
    elif r() &lt; the.Some/i.n : i.ok=False; a[ int(len(a)*r()) ] = x

  def has(i):
    if not i.ok: i._has=sorted(i._has)
    i.sorted=True
    return i._has

  def same(i,j):
    return i.cliffsDelta(j) and i.bootstrap(j)

  def cliffsDelta(i,j):
    n,x,y = 0,i._has, j._has
    if len(x) &gt; 10*len(y): x = random.choices(x,10*len(y))
    if len(y) &gt; 10*len(x): y = random.choices(y,10*len(x))
    for x1 in x:
      for y1 in y:
        n = n + 1
        if x1 &gt; y1: gt = gt + 1 
        if x1 &lt; y1: lt = lt + 1 
    return abs(lt - gt)/n &gt; the.cliffs 

  def bootstrap(i,j,conf=.05):
    y0,z0   = i._has, j._has
    x, y, z = NUM(), NUM(), NUM()
    for y1 in y0: x.add(y1); y.add(y1) 
    for z1 in z0: x.add(z1); z.add(z1) 
    yhat    = [y1 - y.mu + x.mu for y1 in y0]
    zhat    = [z1 - z.mu + x.mu for z1 in z0]
    overall = y.delta(z)
    n       = 0
    for _ in range(the.bootstrap):
      ynum = NUM().adds(sample(yhat))
      znum = NUM().adds(sample(zhat))
      if ynum.delta(znum)  &gt; overall: n += 1
    return n / the.bootstrap &gt;= conf</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="fish.col" href="#fish.col">col</a></li>
<li><a title="fish.obj" href="#fish.obj">obj</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="fish.SOME.add1"><code class="name flex">
<span>def <span class="ident">add1</span></span>(<span>i, x, _)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add1(i,x,_):
  a = i._has
  if   len(a) &lt; the.Some  : i.ok=False; a += [x]
  elif r() &lt; the.Some/i.n : i.ok=False; a[ int(len(a)*r()) ] = x</code></pre>
</details>
</dd>
<dt id="fish.SOME.has"><code class="name flex">
<span>def <span class="ident">has</span></span>(<span>i)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def has(i):
  if not i.ok: i._has=sorted(i._has)
  i.sorted=True
  return i._has</code></pre>
</details>
</dd>
<dt id="fish.SOME.same"><code class="name flex">
<span>def <span class="ident">same</span></span>(<span>i, j)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def same(i,j):
  return i.cliffsDelta(j) and i.bootstrap(j)</code></pre>
</details>
</dd>
<dt id="fish.SOME.cliffsDelta"><code class="name flex">
<span>def <span class="ident">cliffsDelta</span></span>(<span>i, j)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def cliffsDelta(i,j):
  n,x,y = 0,i._has, j._has
  if len(x) &gt; 10*len(y): x = random.choices(x,10*len(y))
  if len(y) &gt; 10*len(x): y = random.choices(y,10*len(x))
  for x1 in x:
    for y1 in y:
      n = n + 1
      if x1 &gt; y1: gt = gt + 1 
      if x1 &lt; y1: lt = lt + 1 
  return abs(lt - gt)/n &gt; the.cliffs </code></pre>
</details>
</dd>
<dt id="fish.SOME.bootstrap"><code class="name flex">
<span>def <span class="ident">bootstrap</span></span>(<span>i, j, conf=0.05)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def bootstrap(i,j,conf=.05):
  y0,z0   = i._has, j._has
  x, y, z = NUM(), NUM(), NUM()
  for y1 in y0: x.add(y1); y.add(y1) 
  for z1 in z0: x.add(z1); z.add(z1) 
  yhat    = [y1 - y.mu + x.mu for y1 in y0]
  zhat    = [z1 - z.mu + x.mu for z1 in z0]
  overall = y.delta(z)
  n       = 0
  for _ in range(the.bootstrap):
    ynum = NUM().adds(sample(yhat))
    znum = NUM().adds(sample(zhat))
    if ynum.delta(znum)  &gt; overall: n += 1
  return n / the.bootstrap &gt;= conf</code></pre>
</details>
</dd>
</dl>
<h3>Inherited members</h3>
<ul class="hlist">
<li><code><b><a title="fish.col" href="#fish.col">col</a></b></code>:
<ul class="hlist">
<li><code><a title="fish.col.add" href="#fish.col.add">add</a></code></li>
<li><code><a title="fish.col.adds" href="#fish.col.adds">adds</a></code></li>
<li><code><a title="fish.col.slots" href="#fish.col.slots">slots</a></code></li>
</ul>
</li>
</ul>
</dd>
<dt id="fish.ROW"><code class="flex name class">
<span>class <span class="ident">ROW</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class ROW(obj):
  def slots(i,cells=[]): return dict(cells=cells)
  def better(i,j,data):
    s1, s2, cols, n = 0, 0, data.y, len(data.y)
    for col in cols:
      a,b  = col.norm(i.cells[col.at]), col.norm(j.cells[col.at])
      s1  -= math.exp(col.w * (a - b) / n)
      s2  -= math.exp(col.w * (b - a) / n)
    return s1 / n &lt; s2 / n</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="fish.obj" href="#fish.obj">obj</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="fish.ROW.slots"><code class="name flex">
<span>def <span class="ident">slots</span></span>(<span>i, cells=[])</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def slots(i,cells=[]): return dict(cells=cells)</code></pre>
</details>
</dd>
<dt id="fish.ROW.better"><code class="name flex">
<span>def <span class="ident">better</span></span>(<span>i, j, data)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def better(i,j,data):
  s1, s2, cols, n = 0, 0, data.y, len(data.y)
  for col in cols:
    a,b  = col.norm(i.cells[col.at]), col.norm(j.cells[col.at])
    s1  -= math.exp(col.w * (a - b) / n)
    s2  -= math.exp(col.w * (b - a) / n)
  return s1 / n &lt; s2 / n</code></pre>
</details>
</dd>
</dl>
</dd>
<dt id="fish.DATA"><code class="flex name class">
<span>class <span class="ident">DATA</span></span>
<span>(</span><span>**d)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">class DATA(obj):
  def slots(i):  return dict(x=[], y=[], cols=[], names=[], rows=[])
  def clone(i,rows=[]):
    d = DATA()
    d.names, d.cols, d.x, d.y = COLS(i.names)
    [d.add(row) for row in rows]
    return d

  def read(i,file):
    with open(file) as fp:
      for line in fp:
        line = re.sub(r&#39;([\n\t\r&#34;\&#39; ]|#.*)&#39;, &#39;&#39;, line)
        if line:
          i.add(ROW(cells = [coerce(s.strip()) for s in line.split(&#34;,&#34;)]))
    return i

  def add(i,row):
    if i.x:
      [col.add(row.cells[col.at]) for cols in [i.x, i.y] for col in cols]
      i.rows += [row]
    else:
      i.names, i.cols, i.x, i.y = COLS(row.cells)
    return i

  def stats(i, cols=None, div=False, rnd=2):
    return obj(N=len(i.rows), **{col.txt: col.stats(div=div, rnd=rnd)
                                 for col in (cols or i.y)})

  def betters(i):
    rows = sorted(i.rows, key=cmp2key(lambda r1,r2: r1.better(r2,i)))
    cut  = len(rows) - int(len(rows))**the.min
    best,rest = [],[]
    for j,row in enumerate(rows):
      row.y = j &gt; cut
      (best if j &gt; cut else rest).append(row)
    rest = random.sample(rest, len(best)*the.rest)
    return i.clone(best), i.clone(rest)</code></pre>
</details>
<h3>Ancestors</h3>
<ul class="hlist">
<li><a title="fish.obj" href="#fish.obj">obj</a></li>
</ul>
<h3>Methods</h3>
<dl>
<dt id="fish.DATA.slots"><code class="name flex">
<span>def <span class="ident">slots</span></span>(<span>i)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def slots(i):  return dict(x=[], y=[], cols=[], names=[], rows=[])</code></pre>
</details>
</dd>
<dt id="fish.DATA.clone"><code class="name flex">
<span>def <span class="ident">clone</span></span>(<span>i, rows=[])</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def clone(i,rows=[]):
  d = DATA()
  d.names, d.cols, d.x, d.y = COLS(i.names)
  [d.add(row) for row in rows]
  return d</code></pre>
</details>
</dd>
<dt id="fish.DATA.read"><code class="name flex">
<span>def <span class="ident">read</span></span>(<span>i, file)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def read(i,file):
  with open(file) as fp:
    for line in fp:
      line = re.sub(r&#39;([\n\t\r&#34;\&#39; ]|#.*)&#39;, &#39;&#39;, line)
      if line:
        i.add(ROW(cells = [coerce(s.strip()) for s in line.split(&#34;,&#34;)]))
  return i</code></pre>
</details>
</dd>
<dt id="fish.DATA.add"><code class="name flex">
<span>def <span class="ident">add</span></span>(<span>i, row)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def add(i,row):
  if i.x:
    [col.add(row.cells[col.at]) for cols in [i.x, i.y] for col in cols]
    i.rows += [row]
  else:
    i.names, i.cols, i.x, i.y = COLS(row.cells)
  return i</code></pre>
</details>
</dd>
<dt id="fish.DATA.stats"><code class="name flex">
<span>def <span class="ident">stats</span></span>(<span>i, cols=None, div=False, rnd=2)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def stats(i, cols=None, div=False, rnd=2):
  return obj(N=len(i.rows), **{col.txt: col.stats(div=div, rnd=rnd)
                               for col in (cols or i.y)})</code></pre>
</details>
</dd>
<dt id="fish.DATA.betters"><code class="name flex">
<span>def <span class="ident">betters</span></span>(<span>i)</span>
</code></dt>
<dd>
<div class="desc"></div>
<details class="source">
<summary>
<span>Expand source code</span>
</summary>
<pre><code class="python">def betters(i):
  rows = sorted(i.rows, key=cmp2key(lambda r1,r2: r1.better(r2,i)))
  cut  = len(rows) - int(len(rows))**the.min
  best,rest = [],[]
  for j,row in enumerate(rows):
    row.y = j &gt; cut
    (best if j &gt; cut else rest).append(row)
  rest = random.sample(rest, len(best)*the.rest)
  return i.clone(best), i.clone(rest)</code></pre>
</details>
</dd>
</dl>
</dd>
</dl>
</section>
</article>
<nav id="sidebar">
<center>
<img src=fisheries.png width=500>
</center>
<h1>Index</h1>
<div class="toc">
<ul></ul>
</div>
<ul id="index">
<li><h3><a href="#header-functions">Functions</a></h3>
<ul class="">
<li><code><a title="fish.coerce" href="#fish.coerce">coerce</a></code></li>
<li><code><a title="fish.COLS" href="#fish.COLS">COLS</a></code></li>
<li><code><a title="fish.COL" href="#fish.COL">COL</a></code></li>
<li><code><a title="fish.contrasts" href="#fish.contrasts">contrasts</a></code></li>
<li><code><a title="fish.want" href="#fish.want">want</a></code></li>
<li><code><a title="fish.rules" href="#fish.rules">rules</a></code></li>
<li><code><a title="fish.sample" href="#fish.sample">sample</a></code></li>
<li><code><a title="fish.recrusivelyMergeNeighbors" href="#fish.recrusivelyMergeNeighbors">recrusivelyMergeNeighbors</a></code></li>
<li><code><a title="fish.entropy" href="#fish.entropy">entropy</a></code></li>
<li><code><a title="fish.showd" href="#fish.showd">showd</a></code></li>
<li><code><a title="fish.show" href="#fish.show">show</a></code></li>
<li><code><a title="fish.prin" href="#fish.prin">prin</a></code></li>
<li><code><a title="fish.round2" href="#fish.round2">round2</a></code></li>
<li><code><a title="fish.flip" href="#fish.flip">flip</a></code></li>
</ul>
</li>
<li><h3><a href="#header-classes">Classes</a></h3>
<ul>
<li>
<h4><code><a title="fish.obj" href="#fish.obj">obj</a></code></h4>
<ul class="">
<li><code><a title="fish.obj.slots" href="#fish.obj.slots">slots</a></code></li>
<li><code><a title="fish.obj.id" href="#fish.obj.id">id</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="fish.BIN" href="#fish.BIN">BIN</a></code></h4>
<ul class="">
<li><code><a title="fish.BIN.slots" href="#fish.BIN.slots">slots</a></code></li>
<li><code><a title="fish.BIN.add" href="#fish.BIN.add">add</a></code></li>
<li><code><a title="fish.BIN.merge" href="#fish.BIN.merge">merge</a></code></li>
<li><code><a title="fish.BIN.merged" href="#fish.BIN.merged">merged</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="fish.col" href="#fish.col">col</a></code></h4>
<ul class="">
<li><code><a title="fish.col.slots" href="#fish.col.slots">slots</a></code></li>
<li><code><a title="fish.col.adds" href="#fish.col.adds">adds</a></code></li>
<li><code><a title="fish.col.add" href="#fish.col.add">add</a></code></li>
<li><code><a title="fish.col.bin" href="#fish.col.bin">bin</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="fish.SYM" href="#fish.SYM">SYM</a></code></h4>
<ul class="two-column">
<li><code><a title="fish.SYM.mid" href="#fish.SYM.mid">mid</a></code></li>
<li><code><a title="fish.SYM.div" href="#fish.SYM.div">div</a></code></li>
<li><code><a title="fish.SYM.stats" href="#fish.SYM.stats">stats</a></code></li>
<li><code><a title="fish.SYM.add1" href="#fish.SYM.add1">add1</a></code></li>
<li><code><a title="fish.SYM.descretize" href="#fish.SYM.descretize">descretize</a></code></li>
<li><code><a title="fish.SYM.merges" href="#fish.SYM.merges">merges</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="fish.NUM" href="#fish.NUM">NUM</a></code></h4>
<ul class="two-column">
<li><code><a title="fish.NUM.mid" href="#fish.NUM.mid">mid</a></code></li>
<li><code><a title="fish.NUM.div" href="#fish.NUM.div">div</a></code></li>
<li><code><a title="fish.NUM.norm" href="#fish.NUM.norm">norm</a></code></li>
<li><code><a title="fish.NUM.stats" href="#fish.NUM.stats">stats</a></code></li>
<li><code><a title="fish.NUM.descretize" href="#fish.NUM.descretize">descretize</a></code></li>
<li><code><a title="fish.NUM.add1" href="#fish.NUM.add1">add1</a></code></li>
<li><code><a title="fish.NUM.merges" href="#fish.NUM.merges">merges</a></code></li>
<li><code><a title="fish.NUM.delta" href="#fish.NUM.delta">delta</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="fish.SOME" href="#fish.SOME">SOME</a></code></h4>
<ul class="">
<li><code><a title="fish.SOME.add1" href="#fish.SOME.add1">add1</a></code></li>
<li><code><a title="fish.SOME.has" href="#fish.SOME.has">has</a></code></li>
<li><code><a title="fish.SOME.same" href="#fish.SOME.same">same</a></code></li>
<li><code><a title="fish.SOME.cliffsDelta" href="#fish.SOME.cliffsDelta">cliffsDelta</a></code></li>
<li><code><a title="fish.SOME.bootstrap" href="#fish.SOME.bootstrap">bootstrap</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="fish.ROW" href="#fish.ROW">ROW</a></code></h4>
<ul class="">
<li><code><a title="fish.ROW.slots" href="#fish.ROW.slots">slots</a></code></li>
<li><code><a title="fish.ROW.better" href="#fish.ROW.better">better</a></code></li>
</ul>
</li>
<li>
<h4><code><a title="fish.DATA" href="#fish.DATA">DATA</a></code></h4>
<ul class="two-column">
<li><code><a title="fish.DATA.slots" href="#fish.DATA.slots">slots</a></code></li>
<li><code><a title="fish.DATA.clone" href="#fish.DATA.clone">clone</a></code></li>
<li><code><a title="fish.DATA.read" href="#fish.DATA.read">read</a></code></li>
<li><code><a title="fish.DATA.add" href="#fish.DATA.add">add</a></code></li>
<li><code><a title="fish.DATA.stats" href="#fish.DATA.stats">stats</a></code></li>
<li><code><a title="fish.DATA.betters" href="#fish.DATA.betters">betters</a></code></li>
</ul>
</li>
</ul>
</li>
</ul>
</nav>
</main>
<footer id="footer">
&copy; 2023 <a href="https://timm.github.io">Tim Menzies</a>,
<a href="mailto:timm@ieee.org">timm@ieee.org</a>, BSD-2.
<p>Generated by <a href="https://pdoc3.github.io/pdoc" title="pdoc: Python API documentation generator"><cite>pdoc</cite> 0.10.0</a>.</p>
</footer>
</body>
</html>